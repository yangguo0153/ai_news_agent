<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‰“å·¥ç‰›é©¬æŠ¥é”€å°åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }

      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .file-list::-webkit-scrollbar {
        width: 4px;
      }

      .file-list::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
      }
    </style>
  </head>

  <body
    class="bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 min-h-screen text-slate-800"
  >
    <!-- Top Navigation Bar -->
    <nav
      class="fixed top-0 left-0 right-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200"
    >
      <div
        class="container mx-auto px-4 py-3 flex justify-between items-center max-w-4xl"
      >
        <span class="font-semibold text-indigo-600">ğŸ§¾ æŠ¥é”€åŠ©æ‰‹</span>
        <div class="flex items-center gap-4">
          <!-- Auth Buttons (shown when logged out) -->
          <div id="authButtons" class="flex gap-2">
            <button
              onclick="showAuthModal('login')"
              class="text-sm text-indigo-600 hover:text-indigo-800 transition"
            >
              ç™»å½•
            </button>
            <button
              onclick="showAuthModal('register')"
              class="text-sm bg-indigo-600 text-white px-3 py-1 rounded-lg hover:bg-indigo-700 transition"
            >
              æ³¨å†Œ
            </button>
          </div>
          <!-- User Dropdown (shown when logged in) -->
          <div id="userMenu" class="hidden flex items-center gap-3">
            <button
              onclick="showHistoryModal()"
              class="text-sm text-slate-600 hover:text-indigo-600 transition"
            >
              ğŸ“œ å†å²è®°å½•
            </button>
            <span id="userDisplayName" class="text-sm text-slate-700"></span>
            <button
              onclick="logout()"
              class="text-sm text-red-500 hover:text-red-700 transition"
            >
              é€€å‡º
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-12 max-w-4xl pt-20">
      <!-- Header -->
      <header class="text-center mb-12 animate-fade-in-down">
        <h1
          class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-pink-600 mb-2"
        >
          æ‰“å·¥ç‰›é©¬æŠ¥é”€å°åŠ©æ‰‹
        </h1>
        <p class="text-slate-500 text-lg">
          ä¸€é”®ç”ŸæˆæŠ¥é”€å• & æ•´ç†å‘ç¥¨ï¼Œæ‹¯æ•‘ä½ çš„ä¸‹ç­æ—¶é—´ ğŸ®ğŸ´
        </p>
      </header>

      <!-- Main Card -->
      <div
        class="glass bg-white rounded-2xl shadow-xl p-8 transition-all duration-300 hover:shadow-2xl"
      >
        <!-- Phase 7: AI-Guided Intake Chat (Default View) -->
        <div id="chatSection" class="space-y-6">
          <div class="text-center mb-8">
            <div
              class="inline-block p-4 rounded-full bg-indigo-50 mb-4 animate-bounce-slow"
            >
              <span class="text-4xl">ğŸ¤–</span>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">
              ä»Šå¤©éœ€è¦æŠ¥é”€ä»€ä¹ˆï¼Ÿ
            </h2>
            <p class="text-slate-500">
              å‘Šè¯‰æˆ‘ä½ çš„åœºæ™¯ï¼Œæ¯”å¦‚ "æ˜¨æ™šåŠ ç­æ‰“è½¦" æˆ– "å»åŒ—äº¬å‡ºå·®"
            </p>
          </div>

          <div
            class="max-w-2xl mx-auto bg-slate-50/50 rounded-2xl p-4 border border-slate-200 h-80 overflow-y-auto mb-4 scroll-smooth"
            id="mainChatHistory"
          >
            <div class="text-left mb-4 animate-fade-in-up">
              <div
                class="inline-block bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-slate-700 border border-slate-100"
              >
                ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æŠ¥é”€åŠ©æ‰‹ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦å¤„ç†å“ªç±»æŠ¥é”€ï¼Ÿ
                <br /><span class="text-xs text-slate-400 mt-2 block"
                  >ä¾‹å¦‚ï¼šåŠ ç­æ‰“è½¦ã€å•†åŠ¡å·®æ—…ã€å›¢é˜Ÿèšé¤</span
                >
              </div>
            </div>
          </div>

          <div class="max-w-2xl mx-auto flex gap-2 relative">
            <input
              type="text"
              id="mainChatInput"
              placeholder="æè¿°æ‚¨çš„æŠ¥é”€åœºæ™¯..."
              class="flex-1 px-5 py-4 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all outline-none shadow-sm text-lg"
              onkeypress="if (event.key === 'Enter') sendMainChat();"
            />
            <button
              onclick="sendMainChat()"
              id="mainChatSendBtn"
              class="bg-gradient-to-r from-indigo-600 to-pink-600 text-white px-8 py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              å‘é€
            </button>
          </div>
        </div>

        <!-- Upload Form (Hidden by default) -->
        <div id="uploadSection" class="hidden animate-fade-in-up">
          <div
            class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"
          >
            <h3
              class="text-xl font-bold text-slate-800 flex items-center gap-2"
            >
              <span id="currentTemplateIcon">ğŸ“„</span>
              <span id="currentTemplateName">é€šç”¨æŠ¥é”€</span>
            </h3>
            <button
              onclick="resetToChat()"
              class="text-sm text-slate-400 hover:text-indigo-600 flex items-center gap-1 transition-colors"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"
                />
              </svg>
              è¿”å›å’¨è¯¢
            </button>
          </div>

          <form id="uploadForm" class="space-y-8">
            <!-- Step 1: Attendance Record -->
            <div class="space-y-3">
              <label
                class="block text-sm font-medium text-slate-700 uppercase tracking-wide"
              >
                1. ä¸Šä¼ æ‰“å¡è®°å½•è¡¨ (.xlsx)
              </label>
              <div class="relative group">
                <input
                  type="file"
                  id="attendanceFile"
                  accept=".xlsx"
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                  required
                />
                <div
                  class="border-2 border-dashed border-indigo-200 rounded-xl p-6 text-center transition-colors group-hover:border-indigo-400 bg-indigo-50/30 group-hover:bg-indigo-50/50"
                  id="attendanceDropzone"
                >
                  <svg
                    class="mx-auto h-12 w-12 text-indigo-400 mb-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                  <p class="text-sm text-slate-600" id="attendanceFileName">
                    ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  Excel æ–‡ä»¶
                  </p>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <!-- Step 2: Screenshots -->
              <div class="space-y-3">
                <label
                  class="block text-sm font-medium text-slate-700 uppercase tracking-wide"
                >
                  2. æ‰“å¡ & åŠ ç­æˆªå›¾
                </label>
                <div class="relative group h-40">
                  <input
                    type="file"
                    id="screenshotsFiles"
                    multiple
                    accept="image/*"
                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                    required
                  />
                  <div
                    class="border-2 border-dashed border-pink-200 rounded-xl p-6 text-center h-full flex flex-col justify-center items-center transition-colors group-hover:border-pink-400 bg-pink-50/30 group-hover:bg-pink-50/50"
                  >
                    <svg
                      class="h-8 w-8 text-pink-400 mb-2"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                      />
                    </svg>
                    <p class="text-sm text-slate-600">æ‰¹é‡ä¸Šä¼ å›¾ç‰‡</p>
                    <p
                      class="text-xs text-slate-400 mt-1"
                      id="screenshotsCount"
                    >
                      å·²é€‰æ‹© 0 å¼ 
                    </p>
                  </div>
                </div>
              </div>

              <!-- Step 3: Invoices -->
              <div class="space-y-3">
                <label
                  class="block text-sm font-medium text-slate-700 uppercase tracking-wide"
                >
                  3. å‘ç¥¨ & è¡Œç¨‹å•
                </label>
                <div class="relative group h-40">
                  <input
                    type="file"
                    id="invoiceFiles"
                    multiple
                    accept=".pdf"
                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                    required
                  />
                  <div
                    class="border-2 border-dashed border-blue-200 rounded-xl p-6 text-center h-full flex flex-col justify-center items-center transition-colors group-hover:border-blue-400 bg-blue-50/30 group-hover:bg-blue-50/50"
                  >
                    <svg
                      class="h-8 w-8 text-blue-400 mb-2"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      />
                    </svg>
                    <p class="text-sm text-slate-600">æ‰¹é‡ä¸Šä¼  PDF</p>
                    <p class="text-xs text-slate-400 mt-1" id="invoicesCount">
                      å·²é€‰æ‹© 0 ä¸ªæ–‡ä»¶
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Button -->
            <button
              type="submit"
              id="submitBtn"
              class="w-full bg-gradient-to-r from-indigo-600 to-pink-600 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transform transition hover:-translate-y-1 active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span id="btnText">ğŸš€ å¼€å§‹å¤„ç†</span>
            </button>

            <!-- Progress Bar Area -->
            <div id="progressArea" class="hidden mt-6 space-y-2">
              <div
                class="flex justify-between text-sm font-medium text-slate-600"
              >
                <span id="progressText">å‡†å¤‡ä¸­...</span>
                <span id="progressPercent">0%</span>
              </div>
              <div
                class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden"
              >
                <div
                  id="progressBar"
                  class="bg-gradient-to-r from-indigo-500 to-pink-500 h-2.5 rounded-full transition-all duration-300"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </form>
        </div>
        <!-- End Upload Section -->

        <!-- Settings Modal -->
        <div
          id="settingsModal"
          class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50"
        >
          <div
            class="relative top-10 mx-auto p-5 border w-[32rem] shadow-lg rounded-md bg-white"
          >
            <div class="mt-3">
              <div class="flex justify-between items-center px-4 mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                  âš™ï¸ æŠ¥é”€è§„åˆ™è®¾ç½®
                </h3>
                <button
                  id="closeSettingsIcon"
                  class="text-gray-400 hover:text-gray-600"
                >
                  <svg
                    class="h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>

              <!-- AI Chat Section -->
              <div class="bg-indigo-50 rounded-lg p-4 mb-6 mx-4">
                <div
                  class="text-sm font-semibold text-indigo-800 mb-2 flex items-center"
                >
                  <span class="mr-2">ğŸ¤– AI é…ç½®åŠ©æ‰‹</span>
                  <span
                    class="text-xs font-normal text-indigo-600 px-2 py-0.5 bg-white rounded-full"
                    >Beta</span
                  >
                </div>
                <div
                  id="chatHistory"
                  class="h-32 overflow-y-auto mb-3 space-y-2 text-sm p-2 bg-white/50 rounded-md border border-indigo-100"
                >
                  <div class="text-slate-500 italic">
                    å°è¯•å¯¹æˆ‘è¯´ï¼š"æˆ‘ä»¬å…¬å¸å«æœªæ¥ç§‘æŠ€ï¼Œæ¯æ™š8ç‚¹åç®—åŠ ç­ï¼Œæ‰“è½¦é™é¢200å…ƒã€‚"
                  </div>
                </div>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="chatInput"
                    placeholder="è¯·è¾“å…¥æ‚¨çš„è§„åˆ™æè¿°..."
                    class="flex-1 px-3 py-2 text-sm border border-indigo-200 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
                  />
                  <button
                    id="sendChatBtn"
                    class="bg-indigo-600 text-white px-3 py-2 rounded-md hover:bg-indigo-700 transition-colors"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                      />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Manual Form (Policy) -->
              <div
                class="border-t border-gray-100 pt-4 px-4 bg-gray-50/50 rounded-b-lg"
              >
                <div
                  class="flex border-b border-gray-200 mb-4 text-sm font-medium"
                >
                  <button
                    id="tabPolicy"
                    class="px-4 py-2 text-indigo-600 border-b-2 border-indigo-600 focus:outline-none"
                    onclick="switchTab('policy')"
                  >
                    æŠ¥é”€è§„åˆ™
                  </button>
                  <button
                    id="tabAi"
                    class="px-4 py-2 text-gray-500 hover:text-gray-700 focus:outline-none"
                    onclick="switchTab('ai')"
                  >
                    ğŸ¤– AI æ¨¡å‹
                  </button>
                </div>

                <!-- Tab: Policy -->
                <div id="contentPolicy">
                  <p class="text-xs text-gray-400 mb-4 font-medium uppercase">
                    åŸºæœ¬è§„åˆ™é…ç½®
                  </p>
                  <div class="grid grid-cols-1 gap-4">
                    <input
                      type="text"
                      id="companyName"
                      placeholder="å…¬å¸åç§°"
                      class="px-3 py-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white"
                    />
                    <div class="grid grid-cols-2 gap-4">
                      <div class="text-left">
                        <label class="text-xs text-gray-500 block mb-1"
                          >åŠ ç­èµ·ç®—æ—¶é—´</label
                        >
                        <input
                          type="time"
                          id="overtimeStart"
                          class="px-3 py-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white"
                        />
                      </div>
                      <div class="text-left">
                        <label class="text-xs text-gray-500 block mb-1"
                          >æ¯æ—¥æ‰“è½¦é™é¢ (å…ƒ)</label
                        >
                        <input
                          type="number"
                          id="taxiLimit"
                          class="px-3 py-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tab: AI Settings -->
                <div id="contentAi" class="hidden">
                  <p class="text-xs text-gray-400 mb-4 font-medium uppercase">
                    LLM æ¨¡å‹é…ç½® (BYOK)
                  </p>
                  <div class="space-y-4">
                    <div>
                      <label class="text-xs text-gray-500 block mb-1"
                        >OpenAI API Key (æˆ–å…¼å®¹ Key)</label
                      >
                      <input
                        type="password"
                        id="aiKey"
                        placeholder="sk-..."
                        class="px-3 py-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white"
                      />
                    </div>
                    <div>
                      <label class="text-xs text-gray-500 block mb-1"
                        >Base URL (å¯é€‰)</label
                      >
                      <input
                        type="text"
                        id="aiBaseUrl"
                        placeholder="https://api.openai.com/v1"
                        class="px-3 py-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white"
                      />
                    </div>
                    <div>
                      <label class="text-xs text-gray-500 block mb-1"
                        >Model Name</label
                      >
                      <input
                        type="text"
                        id="aiModel"
                        placeholder="gpt-3.5-turbo"
                        class="px-3 py-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white"
                      />
                    </div>
                    <p class="text-xs text-gray-400">
                      æç¤ºï¼šKey ä»…ä¿å­˜åœ¨æœ¬åœ°æ•°æ®åº“ä¸­ï¼Œç”¨äºè°ƒç”¨ AI
                      åŠ©æ‰‹è¿›è¡Œæ™ºèƒ½åˆ†æã€‚
                    </p>
                  </div>
                </div>
              </div>

              <div class="px-4 py-4 flex gap-3">
                <button
                  id="saveSettingsBtn"
                  class="flex-1 px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-700 transition focus:outline-none focus:ring-2 focus:ring-indigo-300"
                >
                  ä¿å­˜è®¾ç½®
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Result Area -->
        <div
          id="resultArea"
          class="hidden mt-8 p-6 bg-green-50 rounded-xl border border-green-200 animate-fade-in-up"
        >
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0 bg-green-100 p-2 rounded-full">
              <svg
                class="h-6 w-6 text-green-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                />
              </svg>
            </div>
            <div>
              <h3 id="resultTitle" class="font-bold text-green-800 text-lg">
                å¤„ç†å®Œæˆï¼
              </h3>
              <p id="resultDesc" class="text-green-600 text-sm mt-1">
                ä½ çš„æŠ¥é”€å•å·²ç»å‡†å¤‡å¥½äº†ã€‚
              </p>
            </div>
            <a
              id="downloadLink"
              href="#"
              class="ml-auto bg-green-600 text-white px-6 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors"
            >
              ä¸‹è½½ç»“æœ (ZIP)
            </a>
          </div>
        </div>

        <div
          id="errorArea"
          class="hidden mt-8 p-6 bg-red-50 rounded-xl border border-red-200 animate-fade-in-up"
        >
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0 bg-red-100 p-2 rounded-full">
              <svg
                class="h-6 w-6 text-red-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </div>
            <div>
              <h3 class="font-bold text-red-800">å‡ºé”™äº†</h3>
              <p id="errorText" class="text-red-600 text-sm">
                è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–é‡è¯•ã€‚
              </p>
            </div>
          </div>
        </div>
      </div>

      <footer class="text-center mt-12 text-slate-400 text-sm">
        Powered by Antigravity Agent â€¢ å†…éƒ¨æµ‹è¯•ç‰ˆ
      </footer>
    </div>

    <script>
      // Global auth token - declared first so all functions can access it
      var authToken = localStorage.getItem("reimb_token");

      // Settings Modal Logic
      const modal = document.getElementById("settingsModal");
      const openSettingsBtn = document.createElement("button");
      openSettingsBtn.innerHTML = "âš™ï¸ è®¾ç½®";
      openSettingsBtn.className =
        "absolute top-6 right-6 text-slate-500 hover:text-indigo-600 transition-colors font-medium";
      document.querySelector(".container").prepend(openSettingsBtn);

      openSettingsBtn.onclick = async () => {
        // Fetch current settings
        try {
          const res = await fetch("/api/settings");
          const data = await res.json();
          if (data) {
            document.getElementById("companyName").value =
              data.company_name || "";
            document.getElementById("overtimeStart").value =
              data.overtime_start_time || "19:00";
            document.getElementById("taxiLimit").value =
              data.taxi_daily_limit || 200;
          }
        } catch (e) {
          console.error(e);
        }
        modal.classList.remove("hidden");
        // Settings Modal Elements
        const settingsModal = document.getElementById("settingsModal");
        // openSettingsBtn is already created above
        const closeSettingsIcon = document.getElementById("closeSettingsIcon");
        const saveSettingsBtn = document.getElementById("saveSettingsBtn");

        // Tab Switching
        function switchTab(tab) {
          const contentPolicy = document.getElementById("contentPolicy");
          const contentAi = document.getElementById("contentAi");
          const tabPolicy = document.getElementById("tabPolicy");
          const tabAi = document.getElementById("tabAi");

          if (tab === "policy") {
            contentPolicy.classList.remove("hidden");
            contentAi.classList.add("hidden");
            tabPolicy.className =
              "px-4 py-2 text-indigo-600 border-b-2 border-indigo-600 focus:outline-none";
            tabAi.className =
              "px-4 py-2 text-gray-500 hover:text-gray-700 focus:outline-none";
          } else {
            contentPolicy.classList.add("hidden");
            contentAi.classList.remove("hidden");
            tabPolicy.className =
              "px-4 py-2 text-gray-500 hover:text-gray-700 focus:outline-none";
            tabAi.className =
              "px-4 py-2 text-indigo-600 border-b-2 border-indigo-600 focus:outline-none";
          }
        }

        // Expose switchTab globally for HTML onclick attributes
        window.switchTab = switchTab;

        // Modal Open/Close
        function openSettings() {
          settingsModal.classList.remove("hidden");
          fetchSettings();
          fetchAiSettings();
          switchTab("policy");
        }

        if (openSettingsBtn)
          openSettingsBtn.addEventListener("click", openSettings);
        if (closeSettingsIcon)
          closeSettingsIcon.addEventListener("click", () =>
            settingsModal.classList.add("hidden"),
          );

        // Fetch Functions
        async function fetchSettings() {
          try {
            const response = await fetch("/api/settings");
            const data = await response.json();
            document.getElementById("companyName").value =
              data.company_name || "";
            document.getElementById("overtimeStart").value =
              data.overtime_start_time || "19:00";
            document.getElementById("taxiLimit").value =
              data.taxi_daily_limit || 200;
          } catch (error) {
            console.error("Failed to load settings:", error);
          }
        }

        async function fetchAiSettings() {
          try {
            const res = await fetch("/api/settings/ai", {
              headers: authToken
                ? { Authorization: `Bearer ${authToken}` }
                : {},
            });
            if (res.ok) {
              const data = await res.json();
              document.getElementById("aiKey").value =
                data.openai_api_key || "";
              document.getElementById("aiBaseUrl").value =
                data.openai_base_url || "";
              document.getElementById("aiModel").value = data.model_name || "";
            }
          } catch (e) {
            console.error("Failed to load AI settings", e);
          }
        }

        // Save Settings
        if (saveSettingsBtn)
          saveSettingsBtn.addEventListener("click", async () => {
            // 1. Save Policy
            const companyName = document.getElementById("companyName").value;
            const overtimeStart =
              document.getElementById("overtimeStart").value;
            const taxiLimit = document.getElementById("taxiLimit").value;

            try {
              await fetch("/api/settings", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  ...(authToken
                    ? { Authorization: `Bearer ${authToken}` }
                    : {}),
                },
                body: JSON.stringify({
                  company_name: companyName,
                  overtime_start_time: overtimeStart,
                  taxi_daily_limit: parseFloat(taxiLimit),
                }),
              });

              // 2. Save AI Settings
              const aiKey = document.getElementById("aiKey").value;
              const aiBaseUrl = document.getElementById("aiBaseUrl").value;
              const aiModel = document.getElementById("aiModel").value;

              await fetch("/api/settings/ai", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  ...(authToken
                    ? { Authorization: `Bearer ${authToken}` }
                    : {}),
                },
                body: JSON.stringify({
                  openai_api_key: aiKey || null,
                  openai_base_url: aiBaseUrl,
                  model_name: aiModel,
                }),
              });

              alert("è®¾ç½®å·²ä¿å­˜ï¼");
              settingsModal.classList.add("hidden");
            } catch (error) {
              alert("ä¿å­˜å¤±è´¥: " + error);
            }
          });

        // AI Chat Logic
        const chatInput = document.getElementById("chatInput");
        const sendChatBtn = document.getElementById("sendChatBtn");
        const chatHistory = document.getElementById("chatHistory");

        async function sendChatMessage() {
          const message = chatInput.value.trim();
          if (!message) return;

          // User Message
          appendMessage("user", message);
          chatInput.value = "";

          // Loading state
          const loadingId = appendMessage("ai", "æ€è€ƒä¸­...");

          try {
            const res = await fetch("/api/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message }),
            });
            const data = await res.json();

            // Remove loading
            document.getElementById(loadingId).remove();

            // AI Message
            appendMessage("ai", data.text);

            // Auto-fill form
            if (data.updates) {
              if (data.updates.company_name) {
                document.getElementById("companyName").value =
                  data.updates.company_name;
                flashField("companyName");
              }
              if (data.updates.overtime_start_time) {
                document.getElementById("overtimeStart").value =
                  data.updates.overtime_start_time;
                flashField("overtimeStart");
              }
              if (data.updates.taxi_daily_limit) {
                document.getElementById("taxiLimit").value =
                  data.updates.taxi_daily_limit;
                flashField("taxiLimit");
              }
            }
          } catch (e) {
            console.error(e);
            document.getElementById(loadingId).innerText = "AI æš‚æ—¶æ— æ³•è¿æ¥";
          }
        }

        sendChatBtn.onclick = sendChatMessage;
        chatInput.onkeypress = (e) => {
          if (e.key === "Enter") sendChatMessage();
        };

        function appendMessage(role, text) {
          const div = document.createElement("div");
          const id = "msg-" + Date.now();
          div.id = id;
          div.className = role === "user" ? "text-right" : "text-left";

          const bubble = document.createElement("div");
          bubble.className =
            role === "user"
              ? "inline-block bg-indigo-600 text-white rounded-lg py-2 px-3 max-w-[80%]"
              : "inline-block bg-gray-100 text-gray-800 rounded-lg py-2 px-3 max-w-[80%]";
          bubble.innerText = text;

          div.appendChild(bubble);
          chatHistory.appendChild(div);
          chatHistory.scrollTop = chatHistory.scrollHeight;
          return id;
        }

        function flashField(id) {
          const el = document.getElementById(id);
          el.classList.add("ring-2", "ring-green-400", "bg-green-50");
          setTimeout(() => {
            el.classList.remove("ring-2", "ring-green-400", "bg-green-50");
          }, 1000);
        }

        // File Input Listeners for UX

        // File Input Listeners for UX
        document
          .getElementById("attendanceFile")
          .addEventListener("change", function (e) {
            if (e.target.files.length > 0) {
              document.getElementById("attendanceFileName").textContent =
                e.target.files[0].name;
              document
                .getElementById("attendanceFileName")
                .classList.add("text-indigo-600", "font-semibold");
            }
          });

        document
          .getElementById("screenshotsFiles")
          .addEventListener("change", function (e) {
            document.getElementById("screenshotsCount").textContent =
              `å·²é€‰æ‹© ${e.target.files.length} å¼ `;
            document
              .getElementById("screenshotsCount")
              .classList.add("text-pink-600", "font-semibold");
          });

        document
          .getElementById("invoiceFiles")
          .addEventListener("change", function (e) {
            document.getElementById("invoicesCount").textContent =
              `å·²é€‰æ‹© ${e.target.files.length} ä¸ªæ–‡ä»¶`;
            document
              .getElementById("invoicesCount")
              .classList.add("text-blue-600", "font-semibold");
          });
      };

      // --- Phase 7: Main Chat Logic ---
      const mainChatInput = document.getElementById("mainChatInput");
      const mainChatHistory = document.getElementById("mainChatHistory");
      const chatSection = document.getElementById("chatSection");
      const uploadSection = document.getElementById("uploadSection");

      async function sendMainChat() {
        const text = mainChatInput.value.trim();
        if (!text) return;

        // Add User Message
        addMainChatMessage("user", text);
        mainChatInput.value = "";

        // Show Loading
        const loadingId = addMainChatMessage("assistant", "æ­£åœ¨åˆ†æåœºæ™¯...");

        try {
          // Call API (using existing /api/chat/intake endpoint we will build)
          // For now, mocking the response or using a temporary endpoint
          // We will implement /api/chat/intake in backend next
          const response = await fetch("/api/chat/intake", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...(authToken ? { Authorization: `Bearer ${authToken}` } : {}),
            },
            body: JSON.stringify({ message: text }),
          });

          if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
          }

          const data = await response.json();

          // Remove Loading
          document.getElementById(loadingId).remove();

          // Add AI Response
          addMainChatMessage("assistant", data.message);

          // If template matched, show "Start" button
          if (data.matched_template_id) {
            const btnId = "action-" + Date.now();
            const actionDiv = document.createElement("div");
            actionDiv.className = "text-left mb-4 pl-2";
            actionDiv.innerHTML = `
                        <button onclick="startUpload('${data.matched_template_id}', '${data.template_name}')" 
                            class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-200 transition text-sm flex items-center gap-2">
                            <span>ğŸš€ å¼€å§‹åŠç†ï¼š${data.template_name}</span>
                        </button>
                    `;
            mainChatHistory.appendChild(actionDiv);
            mainChatHistory.scrollTop = mainChatHistory.scrollHeight;
          }
        } catch (err) {
          document.getElementById(loadingId).innerText =
            "ğŸ˜• ç½‘ç»œå¼€å°å·®äº†ï¼Œè¯·é‡è¯•";
        }
      }

      function addMainChatMessage(role, text) {
        const div = document.createElement("div");
        const id = "msg-" + Date.now() + Math.random();
        div.id = id;
        div.className = role === "user" ? "text-right mb-4" : "text-left mb-4";

        const bubble = document.createElement("div");
        bubble.className =
          role === "user"
            ? "inline-block bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md text-left max-w-[80%]"
            : "inline-block bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-slate-700 border border-slate-100 max-w-[80%]";

        // Allow basic HTML for lists
        bubble.innerHTML = text.replace(/\n/g, "<br>");

        div.appendChild(bubble);
        mainChatHistory.appendChild(div);
        mainChatHistory.scrollTop = mainChatHistory.scrollHeight;
        return id;
      }

      function startUpload(templateId, templateName) {
        chatSection.classList.add("hidden");
        uploadSection.classList.remove("hidden");
        document.getElementById("currentTemplateName").textContent =
          templateName;
        // In a real app, we might modify the required fields based on templateId
        // For MVP Phase 7, we just show the standard form but context is set
      }

      function resetToChat() {
        uploadSection.classList.add("hidden");
        chatSection.classList.remove("hidden");
      }

      // Form Submit
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const btn = document.getElementById("submitBtn");
          const btnText = document.getElementById("btnText");
          const progressArea = document.getElementById("progressArea");
          const progressBar = document.getElementById("progressBar");
          const progressText = document.getElementById("progressText");
          const progressPercent = document.getElementById("progressPercent");
          const resultArea = document.getElementById("resultArea");
          const errorArea = document.getElementById("errorArea");

          // Reset UI
          resultArea.classList.add("hidden");
          errorArea.classList.add("hidden");
          btn.disabled = true;
          btnText.textContent = "å¤„ç†ä¸­...";
          progressArea.classList.remove("hidden");

          // Simulated Progress Function
          let progress = 0;
          const steps = [
            { p: 10, t: "æ­£åœ¨ä¸Šä¼ æ–‡ä»¶..." },
            { p: 30, t: "æ­£åœ¨è¯†åˆ«æ‰“å¡è®°å½•..." },
            { p: 50, t: "OCR è¯†åˆ«å‘ç¥¨ä¸­..." },
            { p: 70, t: "æ­£åœ¨åŒ¹é…è¡Œç¨‹å•..." },
            { p: 90, t: "ç”ŸæˆæŠ¥è¡¨ä¸æ±‡æ€»..." },
            { p: 95, t: "å³å°†å®Œæˆ..." },
          ];

          let stepIndex = 0;
          const interval = setInterval(() => {
            if (stepIndex < steps.length) {
              const step = steps[stepIndex];
              if (progress < step.p) {
                progress += Math.random() * 2; // Random increment
                if (progress > step.p) progress = step.p;
              } else {
                stepIndex++;
              }
            }

            // Update UI
            const currentP = Math.min(Math.round(progress), 99);
            progressBar.style.width = `${currentP}%`;
            progressPercent.textContent = `${currentP}%`;
            if (stepIndex < steps.length) {
              progressText.textContent = steps[stepIndex].t;
            }
          }, 100);

          const formData = new FormData();
          formData.append(
            "attendance_file",
            document.getElementById("attendanceFile").files[0],
          );

          for (const file of document.getElementById("screenshotsFiles")
            .files) {
            formData.append("screenshots", file);
          }
          for (const file of document.getElementById("invoiceFiles").files) {
            formData.append("invoices", file);
          }

          try {
            const response = await fetch("/api/process", {
              method: "POST",
              body: formData,
            });

            clearInterval(interval);
            progressBar.style.width = "100%";
            progressPercent.textContent = "100%";
            progressText.textContent = "å¤„ç†å®Œæˆï¼";

            if (response.ok) {
              const data = await response.json();

              // Show Stats in Result Area
              const stats = data.stats || {};
              const resultTitle = document.getElementById("resultTitle");
              const resultDesc = document.getElementById("resultDesc");

              // Format number as currency
              const amount = new Intl.NumberFormat("zh-CN", {
                style: "currency",
                currency: "CNY",
              }).format(stats.total_amount || 0);

              resultTitle.innerHTML = `ğŸ‰ æ­å–œï¼å³å°†å›è¡€ <span class="text-green-600">${amount}</span>`;
              resultDesc.innerHTML = `
                        æˆåŠŸæ•´ç† <b>${stats.matched || 0}</b> æ¬¡è¡Œç¨‹ï¼Œ
                        <span class="${stats.unmatched > 0 ? "text-orange-500 font-bold" : ""}">æœªåŒ¹é… ${stats.unmatched || 0} æ¬¡</span>ã€‚
                        ${stats.unmatched > 0 ? '<br><span class="text-xs text-gray-500">æç¤ºï¼šè¯·æ£€æŸ¥â€œæ— æ³•åŒ¹é…â€æ–‡ä»¶å¤¹ä¸­çš„è¡Œç¨‹å•æ˜¯å¦ä¸å‘ç¥¨ä¸€ä¸€å¯¹åº”ã€‚</span>' : ""}
                    `;

              // Update Download Link
              const link = document.getElementById("downloadLink");
              link.href = data.download_url;
              link.download = ""; // Filename is determined by backend or url

              // Small delay to show 100%
              setTimeout(() => {
                resultArea.classList.remove("hidden");
                btnText.textContent = "ğŸš€ å¼€å§‹å¤„ç†";
                btn.disabled = false;
                // Keep progress bar visible at 100%
              }, 500);
            } else {
              const error = await response.json();
              document.getElementById("errorText").textContent =
                error.detail || "æœªçŸ¥é”™è¯¯";
              errorArea.classList.remove("hidden");
              btn.disabled = false;
              btnText.textContent = "ğŸš€ å¼€å§‹å¤„ç†";
            }
          } catch (err) {
            clearInterval(interval);
            document.getElementById("errorText").textContent =
              "ç½‘ç»œè¯·æ±‚å¤±è´¥: " + err.message;
            errorArea.classList.remove("hidden");
            btn.disabled = false;
            btnText.textContent = "ğŸš€ å¼€å§‹å¤„ç†";
          }
        });
    </script>
    <!-- Auth Modal -->
    <div
      id="authModal"
      class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-fade-in-up"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 id="authModalTitle" class="text-xl font-bold text-slate-800">
            ç™»å½•
          </h3>
          <button
            onclick="closeAuthModal()"
            class="text-slate-400 hover:text-slate-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <form id="authForm" class="space-y-4">
          <input type="hidden" id="authType" value="login" />

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1"
              >ç”µå­é‚®ç®±</label
            >
            <input
              type="email"
              id="authEmail"
              required
              class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none"
              placeholder="name@company.com"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1"
              >å¯†ç </label
            >
            <input
              type="password"
              id="authPassword"
              required
              class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
          </div>

          <div id="registerFields" class="hidden space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1"
                >æ˜¾ç¤ºåç§°</label
              >
              <input
                type="text"
                id="authName"
                class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none"
                placeholder="ä½ çš„æ˜µç§°"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1"
                >å…¬å¸åç§°</label
              >
              <input
                type="text"
                id="authCompany"
                class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none"
                placeholder="å¦‚æœä¸å¡«å°†åŠ å…¥å·²æœ‰å…¬å¸"
              />
            </div>
          </div>

          <div
            id="authError"
            class="hidden p-3 bg-red-50 text-red-600 rounded-lg text-sm"
          ></div>

          <button
            type="submit"
            class="w-full py-3 px-6 bg-gradient-to-r from-indigo-600 to-pink-600 text-white font-semibold rounded-xl shadow-lg hover:opacity-90 transition-all transform hover:-translate-y-0.5"
          >
            æäº¤
          </button>

          <div class="text-center text-sm text-slate-500">
            <span id="authSwitchText">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
            <button
              type="button"
              onclick="toggleAuthMode()"
              class="text-indigo-600 font-semibold hover:underline"
              id="authSwitchLink"
            >
              ç«‹å³æ³¨å†Œ
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- History Modal -->
    <div
      id="historyModal"
      class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl p-6 h-[80vh] flex flex-col animate-fade-in-up"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-slate-800">ğŸ“œ æŠ¥é”€å†å²è®°å½•</h3>
          <button
            onclick="closeHistoryModal()"
            class="text-slate-400 hover:text-slate-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="flex-1 overflow-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="border-b border-slate-100 text-slate-500 text-sm">
                <th class="p-3 font-medium">æ—¥æœŸ</th>
                <th class="p-3 font-medium">ç±»å‹</th>
                <th class="p-3 font-medium text-right">é‡‘é¢</th>
                <th class="p-3 font-medium text-center">çŠ¶æ€</th>
                <th class="p-3 font-medium text-right">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="historyList" class="text-sm text-slate-700">
              <!-- History Items will be inserted here -->
            </tbody>
          </table>
          <div
            id="historyLoading"
            class="text-center py-8 text-slate-400 hidden"
          >
            åŠ è½½ä¸­...
          </div>
          <div id="historyEmpty" class="text-center py-8 text-slate-400 hidden">
            æš‚æ— è®°å½•
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- Auth Logic ---
      // authToken is declared globally in the first script block
      let currentUser = null;

      function updateAuthUI() {
        const authButtons = document.getElementById("authButtons");
        const userMenu = document.getElementById("userMenu");
        const userDisplayName = document.getElementById("userDisplayName");

        if (currentUser) {
          authButtons.classList.add("hidden");
          userMenu.classList.remove("hidden");
          userDisplayName.textContent = `${currentUser.display_name} (${currentUser.company_name || "æœªç»‘å®šå…¬å¸"})`;
        } else {
          authButtons.classList.remove("hidden");
          userMenu.classList.add("hidden");
        }
      }

      async function me() {
        if (!authToken) return;
        try {
          const res = await fetch("/api/auth/me", {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          if (res.ok) {
            currentUser = await res.json();
            updateAuthUI();
          } else {
            logout(); // Invalid token
          }
        } catch (e) {
          console.error("Auth check failed", e);
        }
      }

      function logout() {
        localStorage.removeItem("reimb_token");
        authToken = null;
        currentUser = null;
        updateAuthUI();
      }

      function showAuthModal(type = "login") {
        document.getElementById("authModal").classList.remove("hidden");
        const isRegister = type === "register";
        document.getElementById("authType").value = type;
        document.getElementById("authModalTitle").textContent = isRegister
          ? "æ³¨å†Œ"
          : "ç™»å½•";
        document
          .getElementById("registerFields")
          .classList.toggle("hidden", !isRegister);
        document.getElementById("authSwitchText").textContent = isRegister
          ? "å·²æœ‰è´¦å·ï¼Ÿ"
          : "è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ";
        document.getElementById("authSwitchLink").textContent = isRegister
          ? "ç›´æ¥ç™»å½•"
          : "ç«‹å³æ³¨å†Œ";
        document.getElementById("authError").classList.add("hidden");
      }

      function closeAuthModal() {
        document.getElementById("authModal").classList.add("hidden");
      }

      function toggleAuthMode() {
        const currentType = document.getElementById("authType").value;
        showAuthModal(currentType === "login" ? "register" : "login");
      }

      document
        .getElementById("authForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const type = document.getElementById("authType").value;
          const email = document.getElementById("authEmail").value;
          const password = document.getElementById("authPassword").value;
          const errorDiv = document.getElementById("authError");

          const payload = { email, password };

          if (type === "register") {
            payload.display_name = document.getElementById("authName").value;
            payload.company_name = document.getElementById("authCompany").value;
          }

          try {
            const res = await fetch(`/api/auth/${type}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const data = await res.json();

            if (res.ok) {
              if (type === "login") {
                authToken = data.access_token;
                localStorage.setItem("reimb_token", authToken);
                await me();
                closeAuthModal();
              } else {
                // Auto login after register? Or ask to login via modal?
                // Let's ask to login for simplicity or just auto login if we implemented return token
                // Current register returns UserResponse, so need to login
                alert("æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•");
                toggleAuthMode();
                // Pre-fill email
                document.getElementById("authEmail").value = email;
              }
            } else {
              errorDiv.textContent = data.detail || "è¯·æ±‚å¤±è´¥";
              errorDiv.classList.remove("hidden");
            }
          } catch (err) {
            errorDiv.textContent = "ç½‘ç»œé”™è¯¯";
            errorDiv.classList.remove("hidden");
          }
        });
      // --- History Logic ---
      function showHistoryModal() {
        document.getElementById("historyModal").classList.remove("hidden");
        loadHistory();
      }

      function closeHistoryModal() {
        document.getElementById("historyModal").classList.add("hidden");
      }

      async function loadHistory() {
        const list = document.getElementById("historyList");
        const loading = document.getElementById("historyLoading");
        const empty = document.getElementById("historyEmpty");

        list.innerHTML = "";
        loading.classList.remove("hidden");
        empty.classList.add("hidden");

        try {
          const res = await fetch("/api/history", {
            headers: authToken ? { Authorization: `Bearer ${authToken}` } : {},
          });
          if (res.ok) {
            const data = await res.json();
            loading.classList.add("hidden");
            if (data.length === 0) {
              empty.classList.remove("hidden");
            } else {
              data.forEach((item) => {
                const date = new Date(item.created_at).toLocaleString("zh-CN");
                const amount = new Intl.NumberFormat("zh-CN", {
                  style: "currency",
                  currency: "CNY",
                }).format(item.total_amount);
                const row = `
                                <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                                    <td class="p-3 text-slate-500">${date}</td>
                                    <td class="p-3 font-medium text-slate-700">${item.template_name || "é»˜è®¤"}</td>
                                    <td class="p-3 text-right font-bold text-slate-800">${amount}</td>
                                    <td class="p-3 text-center">
                                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">æˆåŠŸ</span>
                                    </td>
                                    <td class="p-3 text-right">
                                        <a href="${item.download_url}" class="text-indigo-600 hover:text-indigo-800 text-xs font-semibold">ä¸‹è½½</a>
                                    </td>
                                </tr>
                            `;
                list.innerHTML += row;
              });
            }
          }
        } catch (err) {
          loading.textContent = "åŠ è½½å¤±è´¥";
        }
      }

      // Init Check
      me();

      // --- Existing Logic Modifications ---

      // ... (Keep existing drag&drop logic) ...

      const form = document.getElementById("uploadForm");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Check if processing
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn.disabled) return;

        // UI Reset
        const resultArea = document.getElementById("resultArea");
        const errorArea = document.getElementById("errorArea");
        const progressBar = document.getElementById("progressBar");
        const progressPercent = document.getElementById("progressPercent");
        const progressText = document.getElementById("progressText");
        const progressContainer = document.getElementById("progressContainer");
        const btn = document.getElementById("submitBtn");
        const btnText = document.getElementById("btnText");

        resultArea.classList.add("hidden");
        errorArea.classList.add("hidden");
        progressContainer.classList.remove("hidden");
        btn.disabled = true;
        btnText.textContent = "å¤„ç†ä¸­...";

        const formData = new FormData();
        formData.append(
          "attendance_file",
          document.getElementById("attendanceFile").files[0],
        );

        const screenshots = document.getElementById("screenshotsFiles").files;
        for (let i = 0; i < screenshots.length; i++) {
          formData.append("screenshots", screenshots[i]);
        }

        const invoices = document.getElementById("invoiceFiles").files;
        for (let i = 0; i < invoices.length; i++) {
          formData.append("invoices", invoices[i]);
        }

        // Add headers for auth if logged in
        const headers = {};
        if (authToken) {
          headers["Authorization"] = `Bearer ${authToken}`;
        }

        // Simulate Progress (90% in 30s)
        let progress = 0;
        progressBar.style.width = "0%";
        progressText.textContent = "æ­£åœ¨è§£ææ–‡ä»¶...";

        const interval = setInterval(() => {
          if (progress < 90) {
            progress += Math.random() * 5;
            if (progress > 90) progress = 90;
            progressBar.style.width = `${progress}%`;
            progressPercent.textContent = `${Math.round(progress)}%`;

            if (progress > 20 && progress < 50)
              progressText.textContent = "æ­£åœ¨OCRè¯†åˆ«å‘ç¥¨...";
            if (progress > 50 && progress < 80)
              progressText.textContent = "æ­£åœ¨æ™ºèƒ½åŒ¹é…è¡Œç¨‹...";
            if (progress > 80)
              progressText.textContent = "æ­£åœ¨ç”ŸæˆExcelæŠ¥è¡¨...";
          }
        }, 800);

        try {
          const response = await fetch("/api/process", {
            method: "POST",
            body: formData,
            headers: headers, // Add Auth Headers
          });

          clearInterval(interval);
          progressBar.style.width = "100%";
          progressPercent.textContent = "100%";
          progressText.textContent = "å¤„ç†å®Œæˆï¼";

          if (response.ok) {
            const data = await response.json();

            // Show Stats in Result Area
            const stats = data.stats || {};
            const resultTitle = document.getElementById("resultTitle");
            const resultDesc = document.getElementById("resultDesc");

            // Format number as currency
            const amount = new Intl.NumberFormat("zh-CN", {
              style: "currency",
              currency: "CNY",
            }).format(stats.total_amount || 0);

            resultTitle.innerHTML = `ğŸ‰ æ­å–œï¼å³å°†å›è¡€ <span class="text-green-600">${amount}</span>`;
            resultDesc.innerHTML = `
                        æˆåŠŸæ•´ç† <b>${stats.matched || 0}</b> æ¬¡è¡Œç¨‹ï¼Œ
                        <span class="${stats.unmatched > 0 ? "text-orange-500 font-bold" : ""}">æœªåŒ¹é… ${stats.unmatched || 0} æ¬¡</span>ã€‚
                        ${stats.unmatched > 0 ? '<br><span class="text-xs text-gray-500">æç¤ºï¼šè¯·æ£€æŸ¥â€œæ— æ³•åŒ¹é…â€æ–‡ä»¶å¤¹ä¸­çš„è¡Œç¨‹å•æ˜¯å¦ä¸å‘ç¥¨ä¸€ä¸€å¯¹åº”ã€‚</span>' : ""}
                    `;

            // Update Download Link
            const link = document.getElementById("downloadLink");
            link.href = data.download_url;
            link.download = ""; // Filename is determined by backend or url

            // Small delay to show 100%
            setTimeout(() => {
              resultArea.classList.remove("hidden");
              btnText.textContent = "ğŸš€ å¼€å§‹å¤„ç†";
              btn.disabled = false;
              // Keep progress bar visible at 100%
              if (authToken) {
                // Refresh history silently if modal is open? Or just let user click history again
              }
            }, 500);
          } else {
            const error = await response.json();
            document.getElementById("errorText").textContent =
              error.detail || "æœªçŸ¥é”™è¯¯";
            errorArea.classList.remove("hidden");
            btn.disabled = false;
            btnText.textContent = "ğŸš€ å¼€å§‹å¤„ç†";
          }
        } catch (err) {
          clearInterval(interval);
          document.getElementById("errorText").textContent =
            "ç½‘ç»œè¯·æ±‚å¤±è´¥: " + err.message;
          errorArea.classList.remove("hidden");
          btn.disabled = false;
          btnText.textContent = "ğŸš€ å¼€å§‹å¤„ç†";
        }
      });
    </script>
  </body>
</html>
