# 项目开发经验总结 - 财务自动化 Agent

本文档总结了"加班报销自动化"项目开发过程中的关键Bug修复、功能优化点及最佳实践，旨在为后续维护和其他类似项目提供参考。

## 1. 核心架构与流程优化

### 1.1 文件结构简化
- **问题**：原设计将"打卡截图"、"加班申请截图"、"打车发票"、"行程单"分4个文件夹存放，用户整理负担重且容易放错。
- **优化**：合并为2个业务维度的文件夹：
    - `打卡和加班截图`：存放所有证明加班的时间凭证。
    - `打车发票和行程单`：存放所有报销凭证。
- **价值**：降低了用户操作复杂度，代码逻辑也更符合业务直觉。

### 1.2 自动化报告排版
- **痛点**：发票和行程单通常是横版PDF，直接插入Word会导致页面留白过多，打印页数剧增。
- **方案**：
    - 实现 `add_pdf_screenshots_compact` 方法。
    - 采用 **"两张一页、上下排列"** 的布局策略。
    - 使用 `fitz.Matrix(1.5, 1.5)` 对PDF转图片进行适度缩放，兼顾清晰度与页面空间利用率。

### 1.3 文件排序逻辑
- **Bug**：Word汇总报告中，截图顺序混乱，导致人工审核困难。
- **根因**：默认使用文件系统顺序（通常是按名称），但文件命名可能不一致。
- **修复**：在 `main.py` 中强制引入**基于日期的排序逻辑**，优先提取文件名中的日期字段进行排序，确保报告按时间轴生成。

---

## 2. 关键 Bug 修复 (Root Cause Analysis)

### 2.1 OCR 提取不准确
- **现象**：PDF表格线或换行导致OCR识别内容错位，特别是长行程单。
- **修复**：
    - 放弃单纯依赖表格结构的解析库，转而引入**鲁棒的正则表达式 (Regex)**。
    - 针对行程单的多行特性，编写特定正则模式匹配【日期、时间、金额、起终点】。
    - **验证规则**：强制要求提取的金额必须保留2位小数且 `> 20` 元，有效过滤了行号或日期的误匹配。

### 2.2 数据完整性问题
- **现象**：部分固定路线的行程在Excel中金额显示为0。
- **修复**：修改 `extract_trip_sheet_info` 逻辑，**优先使用OCR提取的金额**覆盖默认值，确保数据的真实性。

### 2.3 加班时间提取失败
- **现象**：部分手机截图的时间格式 (HH:mm) 未能被识别。
- **修复**：优化正则表达式，增加对分钟格式的支持，并引入更丰富的关键词（"导出报表"、"工作内容"）来区分不同APP的截图界面。

### 2.4 ⚠️ 重复方法定义（严重Bug）
- **现象**：`ocr_engine.py` 中 `extract_trip_sheet_info` 方法被定义了**两次**（第154行和第321行）。
- **影响**：Python会使用后定义的版本覆盖前面的，导致第154-230行的代码永远不会被执行。
- **根因**：代码迭代过程中，新版本未删除旧版本。
- **修复方案**：删除第154-230行的旧版本，保留第321-414行的优化版本（包含金额严格验证逻辑）。
- **教训**：重构代码时必须确保删除废弃版本，避免重复定义带来的隐蔽bug。

---

## 3. 智能匹配逻辑 (Business Logic Enhancements)

### 3.1 凌晨行程智能匹配
- **业务场景**：员工加班到深夜后，凌晨0-6点打车回家。
- **实现逻辑**（`renamer.py _match_trip_date`）：
    - 对于凌晨0-6点的行程，**优先匹配前一天**的加班记录。
    - 如果前一天无加班，则尝试**匹配当天**（适应加班到凌晨的场景）。
- **价值**：自动处理跨日场景，避免因时间跨天导致的匹配失败。

### 3.2 截图智能配对（基于文件序号）
- **业务场景**：用户批量截图后，打卡和加班申请截图通常文件名连续（如IMG_001.png, IMG_002.png）。
- **实现逻辑**（`renamer.py` 第126-164行）：
    - 当打卡截图OCR未能识别日期时，提取文件名中的序号。
    - 自动查找序号相邻（+1/+2/+3）的加班申请截图，借用其识别出的日期。
- **价值**：大幅减少因OCR失败导致的人工干预，提升自动化率。

### 3.3 截图分类优化
- **挑战**：OCR无法完美区分"打卡截图"和"加班申请截图"。
- **策略**：
    - **打卡关键词**：`["导出报表", "9:00", "18:00", "打卡", "考勤", "上下班"]`
    - **加班申请关键词**：`["加班", "开始时间", "结束时间", "工作内容", "加班地点"]`
    - **排序规则**：同一日期的截图，打卡截图优先排在前。
- **价值**：确保Word报告中的截图顺序符合审核逻辑。

---

## 4. 最佳实践 (Best Practices)

1.  **输入容错**：永远不要相信用户的输入是规范的。必须在代码层面做强类型的正则匹配和逻辑校验（如金额 > 20）。
2.  **依赖明确**：OCR项目必须明确系统级依赖（如 `tesseract`）和Python库依赖（`pytesseract`），并在文档中注明安装方式。
3.  **用户视角**：优化的终极目标是"少即是多"。减少文件夹数量、自动排版节省纸张、按时间排序方便核对，这些都是从用户实际使用场景出发的优化。
4.  **代码重构安全性**：
    - ⚠️ **避免重复定义**：迭代重构时，必须删除旧版本代码，不能让新旧版本同时存在。
    - 使用 `grep` 或 IDE 搜索功能验证方法/函数是否有重复定义。
    - Python的方法覆盖机制会让后定义的版本生效，导致难以发现的逻辑bug。
5.  **正则表达式精确度**：关键数据（如金额）的提取必须使用严格的正则规则，结合业务验证（如金额>=20），避免误匹配日期、序号等干扰数据。
