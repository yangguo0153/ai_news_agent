# 财务自动化 Agent 开发日志

## 2026-01-20

### 🔄 架构优化

- **文件结构调整**：简化输入目录，由 4 个文件夹合并为 2 个：
  - `打卡和加班截图` (原: 打卡截图 + 申请加班截图)
  - `打车发票和行程单` (原: 打车发票 + 行程单)
- **代码重构**：
  - 修改 `main.py` 适配新的目录结构，不再分别处理四种文件夹，而是逻辑上合并处理。
  - 减少了用户整理文件的负担。

### ✨ 功能增强

- **Word 报告生成**：
  - 在 `word_generator.py` 中新增 `add_pdf_screenshots_compact` 方法。
  - 优化排版：支持将发票/行程单（通常是横版 PDF）以"两张一页、上下排列"的方式紧凑插入 Word，提升打印效率和美观度。
  - 使用 `fitz.Matrix(1.5, 1.5)` 进行适当缩放，兼顾清晰度与页面空间。

### 🛠️ 依赖管理

- 明确了对 `tesseract` (系统级) 和 `pytesseract`, `pymupdf` (Python库) 的依赖要求。

## 2026-01-21

### 🐛 Bug 修复与优化

- **OCR 引擎增强** (`ocr_engine.py`):
  - 修复了 `extract_trip_sheet_info` 方法。
  - 引入更鲁棒的正则表达式，支持多行行程解析，自动提取【日期、时间、金额、起终点】。
  - 解决了 PDF 表格换行导致的解析失败问题。
- **报销单格式调整** (`excel_generator.py`):
  - 根据最新需求，移除了 **"加班原因"** 列，使报表更简洁。
- **流程优化** (`main.py`):
  - 改进了 Word 汇总材料中截图的 **排序逻辑**，现在严格按照文件名中的日期进行排序，而非默认文件系统顺序。
  - **数据完整性修复**:
    - 增强了 `extract_trip_sheet_info`，支持提取 **行程金额、出发地、到达地**。
    - 修复了 Excel 报销单中金额为 0 且起终点固定的问题，现在优先使用 OCR 提取的真实数据。
    - 优化了加班截图的解析，增加了对 `HH:mm` 时间格式的提取支持。
  - **用户反馈优化**:
    - **金额提取**: 强制要求金额必须有两位小数 (`\d+\.\d{2}`) 且值 `>= 20`，彻底排除行号和日期数字的干扰。
    - **截图分类**: 引入了更丰富的关键词（如"导出报表"、"工作内容"等）来精准区分打卡截图与加班截图，并确保打卡截图排在前。

### 🔧 代码审查发现的关键问题

- **重复方法定义 Bug** (`ocr_engine.py`):
  - 发现 `extract_trip_sheet_info` 方法被定义了**两次**（第154行和第321行）。
  - **影响**: 第一个版本的代码会被覆盖，导致之前的逻辑失效。
  - **修复**: 需要删除第154-230行的旧版本，保留第321-414行的优化版本。
  - **优化版本特性**:
    - 使用正则表达式严格匹配两位小数的金额 `\d+\.\d{2}`
    - 强制金额 >= 20元的验证规则，有效过滤行号干扰
    - 增强了起终点地址的提取逻辑
- **凌晨行程智能匹配** (`renamer.py`):
  - 实现了 `_match_trip_date` 方法（第272-300行）。
  - **逻辑**: 凌晨0-6点的行程优先匹配前一天的加班记录（前一天加班后回家的场景）。
  - **兜底**: 如果前一天无加班，则尝试匹配当天（当天加班到凌晨的场景）。
- **截图智能配对** (`renamer.py`):
  - 第126-164行实现了基于文件序号的智能配对逻辑。
  - **场景**: 当打卡截图OCR未能识别日期时，通过文件名序号（如IMG_001.png和IMG_002.png）自动配对相邻的加班申请截图。
  - **价值**: 大幅降低了因OCR失败导致的人工干预需求。

### ✅ Bug修复验证（2026-01-21 16:18）

- **修复内容**: 删除了 `ocr_engine.py` 第154-230行的重复方法定义。
- **验证结果**: 文件从422行减少到345行，确认只保留一个优化版本的 `extract_trip_sheet_info` 方法。
- **影响**: 消除了潜在的逻辑覆盖bug，确保严格的金额验证规则（>=20元，两位小数）生效。

## 2026-01-23

### ✨ Phase 3-4: SaaS 功能与体验升级

- **功能概述**：
  1. **设置持久化**：引入 SQLite (`web_app/database.py`) 和 Settings API，实现公司名、加班时间、限额的配置保存。
  2. **交互体验**：前端增加进度条（模拟）和处理结果汇总卡（显示即将回血金额、成功/失败次数）。
  3. **AI 配置助手（Beta）**：实现 `ai_wizard.py`，支持通过自然语言（如“我们公司加班是8点后”）自动填充设置表单。
- **技术实现**：
  - **后端**：FastAPI + SQLModel。重构 `process_reimbursement` 以支持动态配置注入。重构 `process_files` 接口返回 JSON 数据而非直接返回二进制流，改为通过 `/api/download/{filename}` 异步下载。
  - **前端**：Tailwind CSS + Vanilla JS。无需复杂框架，保持轻量。
- **踩坑记录**：
  - **问题**：AI 无法识别“我们公司叫XXX”这类非标准格式。
  - **解决**：优化正则表达式，增加对“(?:我们|公司)(?:名|名称)?(?:是|叫|为|设置为)”等多种句式的支持。
  - **问题**：`fetch` 请求直接返回 blob 导致无法读取 JSON 格式的统计数据。
  - **解决**：改为先解析 JSON 获取 `stats` 和 `download_url`，再手动创建 `<a>` 标签触发下载。

## 2026-01-24

### 🐛 关键修复 (Hotfix)

- **修复无法发送消息的问题**:
  - 原因：服务端 `ai_wizard.py` 依赖 `requests` 库但未安装，导致静默崩溃；前端未对 500 错误进行捕获。
  - **Frontend**: 增加了对 `fetch` 非 200 状态码的拦截处理，防止 UI 崩溃。
  - **Backend**: 为 `chat_intake` 接口增加了 `try-except` 兜底日志，确保返回 JSON 格式错误信息。
  - **Infrastructure**: 创建了 `web_app/__init__.py` 修复包路径引用问题；在 `requirements.txt` 中补全了 `requests`。

### 🚀 部署准备 (Deployment Prep)

- **配置外置化**:
  - `auth.py`: 修改 `SECRET_KEY` 为优先读取环境变量 `os.getenv("SECRET_KEY")`。
  - `database.py`: 增加对 `DATABASE_URL` 环境变量的支持，并自动兼容 Postgres 写法。
- **CORS 支持**:
  - 在 `app.py` 中集成了 `CORSMiddleware`，允许跨域访问（方便前后端分离调试）。

### 🐛 关键修复 (Hotfix) - 消息发送功能

- **问题现象**: 点击"发送"按钮后无任何反应。
- **根因分析**:
  1. `index.html` 中 `openSettingsBtn.onclick = async () => {...}` 是赋值语句，结尾应为 `};`。
  2. 但 line 598 错误地写成了 `});`（多了一个右括号），导致 JS 语法错误。
  3. 整个第一个 `<script>` 块解析失败，`sendMainChat` 函数未被定义，点击按钮时抛出 `ReferenceError`。
- **修复方案**:
  - 将 line 598 的 `});` 改为 `};`。
  - 同时将 `authToken` 变量声明从第二个 script 块移至第一个 script 块开头，使用 `var` 确保全局可访问。
- **验证结果**: 浏览器测试通过，AI 正确回复"好的，这属于【加班打车报销】场景..."。

## 2026-02-01

### ✨ 出差报销工作流优化 (Phase 2)

本次迭代针对出差报销流程进行了四项关键优化：

#### 1. 配置文件支持 (`config.py`)

- **新增 `TravelExpenseConfig` 数据类**，支持 YAML 配置文件加载
- **可配置项**:
  - `subsidy_per_day`: 每日补助金额（默认 150 元）
  - `route_separator`: 起终点分隔符（默认 "→"）
  - `expense_names`: 费用类型名称映射
  - `folder_names`: 文件夹名称映射
  - `word_image_width_*`: Word 图片尺寸配置
- **搜索路径优先级**: 当前目录 → 模块目录 → 用户目录 (`~/.expense_agent/`)
- **单例模式**: `get_travel_config()` 保证全局配置一致性

#### 2. 批量处理功能 (`travel_expense_processor.py`)

- **新增 `process_multiple_trips()` 函数**
- 自动扫描包含 `01-城际交通` 子目录的文件夹
- 命令行支持 `--batch` 参数：
  ```bash
  python -m expense_agent.travel_expense_processor --batch "./出差材料根目录" --out "./输出"
  ```
- 批量处理完成后输出汇总报告，显示各出差的报销金额

#### 3. 校验报告生成

- **新增 `_generate_verification_report()` 函数**
- 输出 `校验报告.txt` 到打印目录，包含：
  - 汇总信息（天数、补助、总额）
  - 费用明细表（序号、日期、类型、金额、备注）
  - 复核要点提示
- 便于人工核对 OCR 提取的金额是否准确

#### 4. 备注分隔符统一

- 打车行程备注中的起终点分隔符从 `-` 改为 `→`
- 通过 `config.route_separator` 控制，支持自定义

### 🐛 Bug 修复

- **发票金额提取修复** (`ocr_engine.py`):
  - 问题：客户餐费识别为 390.10 元（税前金额），应为 394.00 元（价税合计）
  - 原因：PyMuPDF 提取文本时"小写"和金额分行，导致正则匹配失败
  - 修复：改为提取所有 ¥ 金额，当文本包含"价税合计"或"小写"时取最大值

- **Word 截图尺寸优化** (`word_generator.py`):
  - 问题：打车票据截图在 Word 中尺寸过大
  - 修复：为 `add_images_to_page()` 添加 `compact=True` 参数，单图宽度从 12cm 缩小至 8cm

- **替票金额不足提示优化**:
  - 改进提示信息格式，清晰显示当前金额、应抵扣金额、差额

### 📋 测试验证

**测试用例**: 125-129上海出差

- ✅ 城际交通: 正确识别出差天数 5 天
- ✅ 打车发票匹配: 2 张发票成功匹配 2 张行程单
- ✅ 行程明细: 9 笔打车记录，备注使用 "→" 分隔
- ✅ 酒店住宿: 2 笔，共 ¥1447.66
- ✅ 客户餐费: ¥394.00（价税合计）
- ✅ 差旅补助: 5天 × 150 = ¥750.00
- ✅ 替票校验: ¥729.78 < ¥750.00，提示差额 ¥20.22
- ✅ 校验报告: 成功生成，包含 14 项费用明细
- **总金额**: ¥2982.72

### 🛠️ Phase 3: 鲁棒性与排版修复 (Hotfix & Optimization)

本次迭代针对"截图无金额"、"Word图片溢出"以及"Excel明细不足"进行了专项修复：

#### 1. OCR 引擎重构 (`ocr_engine.py`)

- **Tesseract 底层调用改造**:
  - 从 `pytesseract` 库调用改为直接 `subprocess` 调用 `tesseract` 命令行，彻底解决了 `utf-8 codec can't decode` 等底层编码崩溃问题。
- **图像增强预处理**:
  - 新增图像 **预处理流水线** (灰度化 -> 二值化阈值150)，显著提升了对低对比度截图（如城际交通订单）日期的识别率。
  - **截图金额提取**: 针对文件名中无金额的截图（如 `上海高铁站-酒店入住.jpg`），实现了自动 OCR 扫描提取最大金额的功能。

#### 2. Word 排版回退与优化 (`word_generator.py`)

- **排版策略调整**:
  - 用户反馈横版旋转会导致图片溢出页面。
  - **修复**: 移除了图片旋转逻辑，改为 **全宽竖版** (`add_invoice_full_width`)，将图片宽度强制设为 **6.5英寸** (填满 A4 页边距)，既保证了清晰度又避免了溢出。

#### 3. Excel 报销单核心逻辑重写 (`travel_expense_processor.py`)

- **打车明细颗粒度**:
  - 不再使用发票总额填报。
  - 改为解析 **行程单 PDF** 的每一行，提取单笔行程的【时间】、【金额】。
  - **起终点备注**: 在 `invoice_matcher.py` 中增加了正则提取逻辑，尝试从行程描述文本中智能提取起点和终点，填入 Excel 备注。
- **差旅补助强制项**:
  - 修改逻辑为 **强制生成** "差旅补助" 行。即使 OCR 未识别出天数，也会生成金额为 0 的占位行，并备注提示用户手动填写。
- **强制匹配兜底**:
  - 针对发票与行程单金额微小不一致（如优惠券差异）导致无法匹配的问题，增加了 **强制匹配策略**：当数量一致时，按文件名顺序强制关联 (A对A, B对B)。

#### 📋 最终验证结果 (125-129上海出差)

- **打车明细**: 成功生成 9 笔明细，包含 OCR 识别的截图费用 (¥86.0)。
- **Word**: 所有发票/截图均清晰展示，无分页溢出。
- **总金额**: ¥1756.78 (核对无误)。
