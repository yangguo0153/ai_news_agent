# 财务自动化 Agent 开发日志

## 2026-01-20
### 🔄 架构优化
- **文件结构调整**：简化输入目录，由 4 个文件夹合并为 2 个：
  - `打卡和加班截图` (原: 打卡截图 + 申请加班截图)
  - `打车发票和行程单` (原: 打车发票 + 行程单)
- **代码重构**：
  - 修改 `main.py` 适配新的目录结构，不再分别处理四种文件夹，而是逻辑上合并处理。
  - 减少了用户整理文件的负担。

### ✨ 功能增强
- **Word 报告生成**：
  - 在 `word_generator.py` 中新增 `add_pdf_screenshots_compact` 方法。
  - 优化排版：支持将发票/行程单（通常是横版 PDF）以"两张一页、上下排列"的方式紧凑插入 Word，提升打印效率和美观度。
  - 使用 `fitz.Matrix(1.5, 1.5)` 进行适当缩放，兼顾清晰度与页面空间。

### 🛠️ 依赖管理
- 明确了对 `tesseract` (系统级) 和 `pytesseract`, `pymupdf` (Python库) 的依赖要求。

## 2026-01-21
### 🐛 Bug 修复与优化
- **OCR 引擎增强** (`ocr_engine.py`):
    - 修复了 `extract_trip_sheet_info` 方法。
    - 引入更鲁棒的正则表达式，支持多行行程解析，自动提取【日期、时间、金额、起终点】。
    - 解决了 PDF 表格换行导致的解析失败问题。
- **报销单格式调整** (`excel_generator.py`):
    - 根据最新需求，移除了 **"加班原因"** 列，使报表更简洁。
- **流程优化** (`main.py`):
    - 改进了 Word 汇总材料中截图的 **排序逻辑**，现在严格按照文件名中的日期进行排序，而非默认文件系统顺序。
    - **数据完整性修复**: 
        - 增强了 `extract_trip_sheet_info`，支持提取 **行程金额、出发地、到达地**。
        - 修复了 Excel 报销单中金额为 0 且起终点固定的问题，现在优先使用 OCR 提取的真实数据。
        - 优化了加班截图的解析，增加了对 `HH:mm` 时间格式的提取支持。
    - **用户反馈优化**:
        - **金额提取**: 强制要求金额必须有两位小数 (`\d+\.\d{2}`) 且值 `>= 20`，彻底排除行号和日期数字的干扰。
        - **截图分类**: 引入了更丰富的关键词（如"导出报表"、"工作内容"等）来精准区分打卡截图与加班截图，并确保打卡截图排在前。

### 🔧 代码审查发现的关键问题
- **重复方法定义 Bug** (`ocr_engine.py`):
    - 发现 `extract_trip_sheet_info` 方法被定义了**两次**（第154行和第321行）。
    - **影响**: 第一个版本的代码会被覆盖，导致之前的逻辑失效。
    - **修复**: 需要删除第154-230行的旧版本，保留第321-414行的优化版本。
    - **优化版本特性**: 
        - 使用正则表达式严格匹配两位小数的金额 `\d+\.\d{2}`
        - 强制金额 >= 20元的验证规则，有效过滤行号干扰
        - 增强了起终点地址的提取逻辑
- **凌晨行程智能匹配** (`renamer.py`):
    - 实现了 `_match_trip_date` 方法（第272-300行）。
    - **逻辑**: 凌晨0-6点的行程优先匹配前一天的加班记录（前一天加班后回家的场景）。
    - **兜底**: 如果前一天无加班，则尝试匹配当天（当天加班到凌晨的场景）。
- **截图智能配对** (`renamer.py`):
    - 第126-164行实现了基于文件序号的智能配对逻辑。
    - **场景**: 当打卡截图OCR未能识别日期时，通过文件名序号（如IMG_001.png和IMG_002.png）自动配对相邻的加班申请截图。
    - **价值**: 大幅降低了因OCR失败导致的人工干预需求。

### ✅ Bug修复验证（2026-01-21 16:18）
- **修复内容**: 删除了 `ocr_engine.py` 第154-230行的重复方法定义。
- **验证结果**: 文件从422行减少到345行，确认只保留一个优化版本的 `extract_trip_sheet_info` 方法。
- **影响**: 消除了潜在的逻辑覆盖bug，确保严格的金额验证规则（>=20元，两位小数）生效。


## 2026-01-23
### ✨ Phase 3-4: SaaS 功能与体验升级
- **功能概述**：
    1. **设置持久化**：引入 SQLite (`web_app/database.py`) 和 Settings API，实现公司名、加班时间、限额的配置保存。
    2. **交互体验**：前端增加进度条（模拟）和处理结果汇总卡（显示即将回血金额、成功/失败次数）。
    3. **AI 配置助手（Beta）**：实现 `ai_wizard.py`，支持通过自然语言（如“我们公司加班是8点后”）自动填充设置表单。
- **技术实现**：
    - **后端**：FastAPI + SQLModel。重构 `process_reimbursement` 以支持动态配置注入。重构 `process_files` 接口返回 JSON 数据而非直接返回二进制流，改为通过 `/api/download/{filename}` 异步下载。
    - **前端**：Tailwind CSS + Vanilla JS。无需复杂框架，保持轻量。
- **踩坑记录**：
    - **问题**：AI 无法识别“我们公司叫XXX”这类非标准格式。
    - **解决**：优化正则表达式，增加对“(?:我们|公司)(?:名|名称)?(?:是|叫|为|设置为)”等多种句式的支持。
    - **问题**：`fetch` 请求直接返回 blob 导致无法读取 JSON 格式的统计数据。
    - **解决**：改为先解析 JSON 获取 `stats` 和 `download_url`，再手动创建 `<a>` 标签触发下载。

## 2026-01-24
### 🐛 关键修复 (Hotfix)
- **修复无法发送消息的问题**: 
    - 原因：服务端 `ai_wizard.py` 依赖 `requests` 库但未安装，导致静默崩溃；前端未对 500 错误进行捕获。
    - **Frontend**: 增加了对 `fetch` 非 200 状态码的拦截处理，防止 UI 崩溃。
    - **Backend**: 为 `chat_intake` 接口增加了 `try-except` 兜底日志，确保返回 JSON 格式错误信息。
    - **Infrastructure**: 创建了 `web_app/__init__.py` 修复包路径引用问题；在 `requirements.txt` 中补全了 `requests`。

### 🚀 部署准备 (Deployment Prep)
- **配置外置化**:
    - `auth.py`: 修改 `SECRET_KEY` 为优先读取环境变量 `os.getenv("SECRET_KEY")`。
    - `database.py`: 增加对 `DATABASE_URL` 环境变量的支持，并自动兼容 Postgres 写法。
- **CORS 支持**:
    - 在 `app.py` 中集成了 `CORSMiddleware`，允许跨域访问（方便前后端分离调试）。

### 🐛 关键修复 (Hotfix) - 消息发送功能
- **问题现象**: 点击"发送"按钮后无任何反应。
- **根因分析**: 
    1. `index.html` 中 `openSettingsBtn.onclick = async () => {...}` 是赋值语句，结尾应为 `};`。
    2. 但 line 598 错误地写成了 `});`（多了一个右括号），导致 JS 语法错误。
    3. 整个第一个 `<script>` 块解析失败，`sendMainChat` 函数未被定义，点击按钮时抛出 `ReferenceError`。
- **修复方案**: 
    - 将 line 598 的 `});` 改为 `};`。
    - 同时将 `authToken` 变量声明从第二个 script 块移至第一个 script 块开头，使用 `var` 确保全局可访问。
- **验证结果**: 浏览器测试通过，AI 正确回复"好的，这属于【加班打车报销】场景..."。

