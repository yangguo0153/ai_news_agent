# Agent Swarm 工作规范

> 本文档定义了 Agent Swarm 中各角色的工作规范和流程机制
> 适用于：客户经理、策划者、Writer、审核者、输出校订者

---

## 一、架构概览

### 1.1 角色定义

```
@main (Orchestrator)
  ├─ 职责：调度、初始化 Shared Context、异常处理、返回结果
  └─ 不处理业务逻辑

业务角色（按执行顺序）：
  1. 客户经理：消化需求、与用户确认、输出 customer_brief
  2. 策划者：思考传播方向、输出 planner_brief
  3. Writer×N：并行创作内容、输出 contents
  4. 审核者：质量检查、反馈修改意见、控制循环
  5. 输出校订者：合规校验、输出 Excel
```

### 1.2 Shared Context（Mail 机制）

所有角色共享的状态，确保信息传递完整：

```python
class SharedContext:
    user_input: Dict          # 用户输入
    customer_brief: Dict      # 客户经理输出
    planner_brief: Dict       # 策划者输出
    contents: List[Dict]      # Writer 输出
    review_results: List[Dict] # 审核者输出
    final_output: str         # 输出校订者输出
    metadata: Dict            # 元数据
```

**核心原则**：下游角色可以看到上游角色的所有输出。

---

## 二、客户经理工作规范

### 2.1 职责

1. 接收用户输入（车型/平台/数量/方向）
2. 通过提问补充关键信息（侧重点/目标用户/核心卖点/调性）
3. 与用户确认需求
4. 输出结构化的 `customer_brief`

### 2.2 可读取的材料

- `02-参考学习/01-客户经理材料/需求消化模板.md`

### 2.3 可读取的 Shared Context

- `user_input`（用户的原始输入）

### 2.4 工作流程

1. **读取用户输入**
2. **补充关键信息**（使用 AskUserQuestion）
   - 传播侧重点（情感共鸣/理性对比/场景展示）
   - 目标用户画像（宝妈/上班族/孝子/小夫妻/事业有成）
   - 核心卖点偏好（空间/安全/智能/省心/舒适）
3. **确认需求**（使用 AskUserQuestion）
4. **输出 customer_brief**（JSON格式）

### 2.5 输出格式

```json
{
  "车型": "CR-V",
  "平台": "抖音",
  "数量": 15,
  "方向": "春节返乡",
  "侧重点": "情感共鸣",
  "目标用户": ["宝妈", "孝子", "小夫妻"],
  "核心卖点": ["空间", "安全"],
  "调性": "温和喜庆",
  "特殊要求": "避免直白描述，多用场景暗示"
}
```

### 2.6 注意事项

- ✅ 必须与用户确认 Brief
- ✅ 必须明确调性和侧重点
- ✅ 必须输出结构化 JSON
- ❌ 不要直接接受模糊需求
- ❌ 不要自行脑补用户意图

---

## 三、策划者工作规范

### 3.1 职责

1. 读取 `customer_brief`
2. 思考传播方向、话题切入点、用户共鸣点
3. 为N篇内容分配人设、卖点、风格
4. 输出 `planner_brief`（包含分配表）

### 3.2 可读取的材料

- `02-参考学习/02-策划者材料/传播方向案例库.md`

### 3.3 可读取的 Shared Context

- `user_input`
- `customer_brief`

### 3.4 工作流程

1. **分析需求**
   - 提取方向、目标用户、核心卖点、调性
2. **生成分配表**
   - 人设分配（确保平衡，每个人设数量相近）
   - 卖点分配（确保每个卖点至少2篇）
   - 场景分配（根据人设和卖点选择）
3. **确认分配表**（使用 AskUserQuestion）
4. **输出 planner_brief**

### 3.5 输出格式

```json
{
  "传播方向": "春节返乡-情感路线",
  "话题切入点": "回家的路 = 爱的路",
  "assignments": [
    {
      "id": 1,
      "persona": "宝妈",
      "selling_point": "空间",
      "scene": "带娃回家，后备箱装满年货",
      "style": "温情"
    },
    // ... 共N篇
  ]
}
```

### 3.6 注意事项

- ✅ 确保人设分配平衡
- ✅ 确保卖点分配平衡
- ✅ 避免自嗨（传播方向必须可执行）
- ❌ 不要脱离用户真实场景

---

## 四、Writer 工作规范

### 4.1 职责

1. 读取分配任务（人设/卖点/场景）
2. 读取结构模板和内容变量（随机抽取）
3. 创作250-350字的内容
4. 自检并输出

### 4.2 可读取的材料

- `02-参考学习/03-Writer材料/结构模板库/春节返乡-情感路线.md`
- `02-参考学习/03-Writer材料/内容变量库/细节描写库.md`（随机抽取3-5个）
- Shared Context 中的 `customer_brief` 和 `planner_brief`

### 4.3 工作流程

1. **读取分配任务**
2. **随机抽取内容变量**（细节描写、口吻样本）
3. **按4段式结构创作**
   - 段1：春节场景唤醒（30-50字）- 必须包含时间触发词
   - 段2：以前vs现在对比（80-120字）
   - 段3：为什么选CR-V（80-120字）- 大维度卖点
   - 段4：情感升华（30-50字）
4. **自检**（字数/禁用词/参数数量）
5. **输出**

### 4.4 创作要求

**字数**：250-350字

**结构**：4段式

**参数**：≤2个

**调性**：温和喜庆、场景化、情感共鸣

**禁止**：
- 禁用词：说实话、但问题来了、你看、首先、其次、方面
- 直白描述：避免"父母年纪大了，万一遇到紧急情况"
- 激进表达：避免"智商税""买教训"
- 单一轻量配置：不单独讲唱吧/LED大灯

### 4.5 注意事项

- ✅ 学习参考样本的"感觉"和"节奏"
- ✅ 创造新的场景和比喻
- ❌ 不要照抄样本的完整句子
- ❌ 不要使用禁用词

---

## 五、审核者工作规范

### 5.1 职责

1. 逐项检查硬性规则
2. 生成修改建议
3. 决定是否通过或退回修改
4. 控制修改循环（最多3次）

### 5.2 可读取的材料

- `02-参考学习/04-审核者材料/硬性规则清单.md`
- Shared Context 中的所有内容

### 5.3 工作流程

1. **逐项检查**
   - 字数规则：250-350字（抖音）
   - 结构规则：4段式
   - 开头规则：必须包含时间触发词
   - 参数规则：≤2个，不能是轻量配置
   - 禁用词规则：不能包含 AI 句式黑名单
   - 去重规则：与相邻5篇不重复
2. **生成修改建议**
3. **决定通过或退回**
   - 无问题 → 通过
   - 有问题 && attempt < 3 → 退回修改
   - 有问题 && attempt >= 3 → 人工介入
4. **输出审核结果**

### 5.4 输出格式

```json
{
  "id": 1,
  "passed": false,
  "issues": ["字数不足（仅200字）", "包含禁用词：说实话"],
  "suggestions": ["增加内容至250-350字", "删除'说实话'"],
  "attempt": 1
}
```

### 5.5 注意事项

- ✅ 必须逐项检查所有硬性规则
- ✅ 必须生成具体的修改建议
- ✅ 3次修改仍不通过 → 人工介入
- ❌ 不要放过任何违规内容

---

## 六、输出校订者工作规范

### 6.1 职责

1. 检查合规性（无敏感词、无负面表达）
2. 检查 Anti-AI-style（是否像人写的）
3. 输出 Excel 文件

### 6.2 可读取的材料

- `02-参考学习/05-输出校订者材料/Anti-AI-style特征库.md`
- Shared Context 中的所有内容

### 6.3 工作流程

1. **合规性检查**
   - 无敏感词
   - 无负面表达（春节场景）
   - 无过度承诺
2. **Anti-AI-style 检查**
   - 枚举式结构（"首先XX，其次XX"）
   - "方面"句式
   - "不得不说"句式
   - 过度对称
   - 缺乏口语感
3. **输出 Excel**

### 6.4 注意事项

- ✅ 必须检查所有通过审核的内容
- ✅ 必须输出 Excel 文件
- ❌ 不要修改内容，只检查

---

## 七、流程控制机制

### 7.1 审核-修改循环

```python
for attempt in range(1, 4):  # 最多3次
    review_results = 审核者(contents)

    if all_passed:
        break  # 全部通过，结束循环

    if attempt >= 3:
        # 人工介入
        mark_for_manual_review()
        break

    # 退回修改
    failed_ids = get_failed_ids(review_results)
    contents = Writer(contents, retry_ids=failed_ids, attempt=attempt+1)
```

### 7.2 人工介入触发条件

- 3次修改仍不通过
- 审核者检测到严重问题（合规性、抄袭）
- Writer 连续失败（API 错误、超时）

---

## 八、分层披露策略

### 8.1 原则

不同角色只看到需要的材料，避免信息过载和照抄。

### 8.2 披露矩阵

| 角色 | 可见材料 | 不可见材料 |
|------|---------|-----------|
| 客户经理 | 需求消化模板 | 其他所有材料 |
| 策划者 | 传播方向案例库 | Writer/审核者材料 |
| Writer | 结构模板+内容变量库 | 完整范文 |
| 审核者 | 硬性规则清单 | Writer材料 |
| 输出校订者 | Anti-AI-style特征库 | 其他所有材料 |

### 8.3 随机抽样（Writer 阶段）

- 每个 Writer 随机抽取 3-5 个细节描写样本
- 每个 Writer 随机抽取 2 个口吻样本
- 物理隔离，避免照抄同一样本

---

## 九、质量标准

### 9.1 硬性指标

| 指标 | 目标值 | 检查方式 |
|------|-------|---------|
| 字数合规率 | 100% | 机械检查 |
| 禁用词检出率 | 0% | 机械检查 |
| 参数合规率 | 100% | 机械检查 |
| 结构合规率 | 100% | 机械检查 |

### 9.2 软性指标

| 指标 | 目标值 | 检查方式 |
|------|-------|---------|
| 开头去重率 | > 80% | 人工抽查 |
| 细节多样性 | > 70% | 人工抽查 |
| 调性符合度 | > 80% | 人工抽查 |

---

## 十、异常处理

### 10.1 API 调用失败

- Writer 调用 LLM API 失败 → 使用备用内容 → 标记为失败
- 连续3次失败 → 人工介入

### 10.2 审核循环死锁

- 3次修改仍不通过 → 人工介入
- 记录失败原因，用于后续优化

### 10.3 材料文件缺失

- 加载材料失败 → 记录错误 → 使用默认规则
- 不阻塞流程，但记录日志

---

_最后更新：2026-02-11_
_版本：v1.0_
