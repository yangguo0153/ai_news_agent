# Agent Swarm 重构项目 - 任务计划

> 项目：将 content-expansion skill 重构为 Agent Swarm 架构
> 开始时间：2026-02-11
> 当前阶段：Phase 2 - 功能完善

---

## 目标

将单 Agent 串行生成模式重构为 Agent Swarm 协作模式，实现：
1. 职责分离（5个业务角色 + @main 编排者）
2. Shared Context（Mail 机制）
3. 分层披露（避免照抄参考材料）
4. 质量提升（降低同质化、提高审核通过率）

---

## 阶段规划

### Phase 1: 架构设计与原型实现 ✅ COMPLETE

**目标**：验证 Agent Swarm 架构可行性

**任务**：
- [x] 架构设计（分离模式：@main 独立）
- [x] 清理临时文件
- [x] 重构参考材料（按角色分层）
- [x] 编写 5 个角色 Prompt
- [x] 实现 LangGraph 原型代码
- [x] 设计测试方案
- [x] 运行基础测试（5篇）

**成果**：
- 架构文档：`docs/architecture_design.md`
- 材料重构：`02-参考学习-重构版/`（6个材料文件）
- Prompt 文件：`prompts/`（5个角色）
- 原型代码：`swarm_prototype.py`
- 测试通过：5/5 篇（100%通过率）

**完成时间**：2026-02-11

---

### Phase 2: 功能完善 ✅ COMPLETE

**目标**：实现完整功能，接入真实 LLM

**任务**：
- [x] 修复细节插入逻辑（从文件动态加载细节库）✅ 2026-02-11
- [x] 实现真实 LLM 调用（替换模拟内容生成）✅ 2026-02-11
- [x] 集成 Deepseek API ✅ 2026-02-11
- [x] 创建 Agent Swarm 工作规范文档 ✅ 2026-02-11
- [x] 实现审核-修改循环（3次上限 + 人工介入）✅ 2026-02-11
- [x] 补充缺失材料（口吻样本库、场景切入库、人设角度库）✅ 2026-02-11
- [x] 实现 Excel 输出（替换文本输出）✅ 2026-02-11
- [ ] 实现 AskUserQuestion 交互（客户经理、策划者确认）⏸️ 暂缓至 Phase 3
- [x] 整理工作区架构（归档文档和备份）✅ 2026-02-11

**成果**：
- ✅ 基础原型验证通过
- ✅ 工作区架构整理完成
- ✅ 真实 LLM 调用实现完成
- ✅ Deepseek API 集成完成（5/5 通过）
- ✅ Agent Swarm 工作规范文档完成
- ✅ 审核-修改循环实现完成（3个测试场景全部通过）
- ✅ 细节库动态加载（69条样本）
- ✅ Excel 输出实现（三 Sheet 格式）
- ✅ 材料库扩充（口吻、场景、人设、细节）

**完成时间**：2026-02-11

---

### Phase 3: 质量优化 🔄 IN PROGRESS

**目标**：提升内容质量和多样性

**优先级排序**：
1. **P0 - 核心功能补全** ✅ COMPLETE
   - [x] 实现 AskUserQuestion 交互（客户经理、策划者确认）✅ 2026-02-11
   - [x] 使用新材料库优化 Prompt（口吻、场景、人设）✅ 2026-02-11

2. **P1 - 内容质量提升** ✅ COMPLETE
   - [x] 强化字数控制提示 ✅ 2026-02-11
   - [x] 增强审核逻辑（情感共鸣度、场景化程度）✅ 2026-02-11
   - [x] 优化修改建议生成 ✅ 2026-02-11
   - [ ] 实现 LLM 软性审核（调性、风格）⏸️ 暂缓

3. **P2 - 性能优化** 🔄 IN PROGRESS
   - [x] 优化字数控制（调整 LLM 参数）✅ 2026-02-11
   - [x] Writer 并行执行（提升生成速度）✅ 2026-02-11
   - [ ] 批量生成支持（多车型/平台）
   - [ ] API 调用优化（降低成本）

4. **P3 - 评估与迭代**
   - [ ] 对比测试（v5.2 vs Swarm）
   - [ ] 评估指标（同质化率、照抄率、审核通过率）
   - [ ] 扩充细节描写库（持续增加样本）

**当前状态**：
- ✅ 材料库已扩充（口吻、场景、人设、细节）
- ✅ AskUserQuestion 交互已实现（客户经理、策划者）
- ✅ Prompt 已优化（整合 5 类参考材料）
- ✅ 审核逻辑已增强（场景化、情感共鸣评分）
- ⚠️ 字数控制需进一步优化（首次通过率 20%）

---

### Phase 4: Web 开发 📋 PENDING

**目标**：提供 Web 界面，让文案同事使用

**任务**：
- [ ] 设计 Web 前端（Next.js + Tailwind CSS）
- [ ] 实现后端 API（FastAPI + LangGraph）
- [ ] 实时进度展示
- [ ] 人工干预点
- [ ] 结果导出（Excel）
- [ ] 用户反馈池

---

### Phase 5: 生产优化 📋 PENDING

**目标**：稳定、高效、可扩展

**任务**：
- [ ] 多模型 API 调用（GPT-4、Claude、Deepseek）
- [ ] 信息抓取者角色（爬取竞品、热点）
- [ ] 用户反馈池（标注、分析、微调）
- [ ] 成本优化（弱模型做简单任务）
- [ ] 监控告警（任务失败、质量下降）

---

## 关键决策

### 决策1：@main 架构模式
- **选择**：分离模式（@main 独立，客户经理是第一个业务角色）
- **理由**：职责清晰、容错性强、可扩展
- **日期**：2026-02-11

### 决策2：材料披露策略
- **选择**：渐进式为主 + 随机式为辅
- **理由**：确保角色看到上游输出，Writer 阶段随机抽取避免照抄
- **日期**：2026-02-11

### 决策3：材料组织方式
- **选择**：从"范文"改为"规则"（结构模板 + 内容变量）
- **理由**：避免照抄，学习"感觉"而非句式
- **日期**：2026-02-11

---

## 错误日志

| 错误 | 尝试 | 解决方案 | 日期 |
|------|------|---------|------|
| ModuleNotFoundError: langgraph | 1 | pip install langgraph anthropic | 2026-02-11 |
| 审核不通过：字数不足（240-246字） | 2 | 调整内容模板，增加字数至250+字 | 2026-02-11 |

---

## 文件清单

### 核心代码
- `swarm_prototype.py` - Agent Swarm 原型程序
- `swarm_with_llm.py` - Agent Swarm 主程序（已实现审核-修改循环、Excel 输出、细节库加载）
- `test_review_loop.py` - 审核-修改循环单元测试
- `test_e2e_loop.py` - 端到端测试

### 文档
- `docs/architecture_design.md` - 架构设计
- `docs/cleanup_report.md` - 清理报告
- `docs/material_migration_report.md` - 材料迁移报告
- `docs/test_plan.md` - 测试方案
- `docs/agent_team_summary.md` - Agent Team 执行总结
- `IMPLEMENTATION_SUMMARY.md` - Phase 2 实施总结（审核-修改循环、Excel 输出、材料扩充）
- `INTERACTION_IMPLEMENTATION.md` - AskUserQuestion 交互实施总结
- `PROMPT_OPTIMIZATION.md` - Prompt 优化实施总结（使用新材料库）
- `task_plan.md` - 项目任务计划

### 参考材料
- `02-参考学习/` - 按角色分层的参考材料
  - `01-客户经理材料/`
  - `02-策划者材料/`
  - `03-Writer材料/`
    - `内容变量库/`
      - `细节描写库.md`（69条样本）
      - `口吻样本库.md`（4种人设）
      - `场景切入库.md`（5种场景）
      - `人设角度库.md`（4种视角）
  - `04-审核者材料/`
  - `05-输出校订者材料/`

### 输出
- `output.txt` - 原型测试输出
- `output_llm.txt` - LLM 测试输出（文本备份）
- `04-产出仓库/*.xlsx` - Excel 格式输出

---

## 下一步行动

**Phase 3 优先任务**（按优先级排序）：

### P0 - 核心功能补全
1. ✅ **实现 AskUserQuestion 交互** - 已完成
   - 客户经理阶段：需求确认
   - 策划者阶段：分配表确认
   - 跳过机制：用户可选择跳过所有确认

2. **使用新材料库优化 Prompt** - 进行中
   - Writer Prompt 引用口吻样本库
   - Writer Prompt 引用场景切入库
   - Writer Prompt 引用人设角度库

### P1 - 内容质量提升
3. **增强审核逻辑**
   - 添加情感共鸣度检查
   - 添加场景化程度检查
   - 实现 LLM 软性审核（调性、风格）

4. **优化修改建议生成**
   - 更具体的修改建议
   - 引用材料库中的优秀案例
   - 提供修改方向而非简单重写

### P2 - 性能优化
5. **批量生成支持**
   - 支持多车型/平台批量生成
   - 并行化内容生成流程
   - 优化 API 调用效率

### P3 - 评估与迭代
6. **对比测试与评估**
   - v5.2 vs Swarm 对比测试
   - 评估指标：同质化率、照抄率、审核通过率
   - 持续扩充细节描写库

---

**Phase 2 已完成**：
- ✅ 整理工作区架构
- ✅ 实现真实 LLM 调用
- ✅ 实现审核-修改循环
- ✅ 修复细节插入逻辑（动态加载 69 条样本）
- ✅ 实现 Excel 输出（三 Sheet 格式）
- ✅ 补充缺失材料（口吻、场景、人设、细节）

**Phase 3 已完成**：
- ✅ 实现 AskUserQuestion 交互（客户经理、策划者）
- ✅ 使用新材料库优化 Prompt（口吻、场景、细节）
- ✅ 强化字数控制提示
- ✅ 增强审核逻辑（场景化、情感共鸣评分）
- ✅ 优化修改建议生成

---

_最后更新：2026-02-11（Phase 3 P0-P1 完成）_
